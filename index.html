<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Geoportal Interactivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet Side-by-Side CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-side-by-side@2.1.0/leaflet-side-by-side.css" />

  <style>
    #map {
      height: 100vh;
      width: 100%;
    }

    .info.legend {
      background: white;
      padding: 8px;
      font-size: 14px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
      line-height: 18px;
    }

    .info.legend i {
      display: inline-block;
      width: 18px;
      height: 18px;
      margin-right: 8px;
      vertical-align: middle;
    }

    /* CONTROLES ORDENADOS Y RESPONSIVOS */
    #busqueda, #compararNDVI, #exportar, #descargarCSV {
      position: absolute;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      width: 220px;
      margin-bottom: 12px;
      /* Evita que se monten */
    }
    #busqueda { top: 10px; }
    #compararNDVI { top: 80px; }
    #exportar { top: 150px; }
    #descargarCSV { top: 220px; }

    #busqueda input {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
    }

    #busqueda button, 
    #compararNDVI button, 
    #exportar button, 
    #descargarCSV button {
      width: 100%;
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 6px;
      box-sizing: border-box;
    }

    /* Responsivo para pantallas pequeñas */
    @media (max-width: 600px) {
      #busqueda, #compararNDVI, #exportar, #descargarCSV {
        position: static;
        width: auto;
        margin: 5px 10px;
        box-shadow: none;
      }
      #busqueda input {
        width: 100%;
      }
      #busqueda button, 
      #compararNDVI button, 
      #exportar button, 
      #descargarCSV button {
        width: 100%;
        margin-top: 6px;
      }
    }
  </style>
</head>
<body>

<!-- Controles -->
<div id="busqueda">
  <input type="text" id="inputSector" placeholder="Buscar Sector..." onkeypress="if(event.key==='Enter'){buscarSector();}" />
  <button onclick="buscarSector()">Buscar</button>
</div>

<div id="compararNDVI">
  <button onclick="toggleCompararNDVI()">Activar comparación NDVI</button>
</div>

<div id="exportar">
  <button onclick="exportarMapa()">Exportar Mapa (PNG)</button>
</div>

<div id="descargarCSV">
  <button onclick="descargarCSV()">Descargar atributos CSV</button>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Side-by-Side JS -->
<script src="https://unpkg.com/leaflet-side-by-side@2.1.0/leaflet-side-by-side.min.js"></script>

<!-- leaflet-image para exportar mapa como PNG -->
<script src="https://rawgit.com/mapbox/leaflet-image/gh-pages/leaflet-image.js"></script>

<script>
  var map = L.map('map').setView([-1.5, -78.5], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  var overlayLayers = {};
  var capaSector = null;
  var capaNDVI2020 = null;
  var capaNDVI2024 = null;
  var sideBySideControl = null;

  function estiloNDVI(feature) {
    const clase = (feature.properties.CLASE || "").trim();
    const colores = {
      "Agua, sombra, suelos saturados": "#d73027",
      "Suelo desnudo, áreas sin vegetación": "#fc8d59",
      "Vegetación muy escasa o seca": "#fee08b",
      "Vegetación moderada o pastizales": "#d9ef8b",
      "Vegetación abundante": "#1a9850",
      "Vegetación muy densa y saludable": "#004529"
    };
    return {
      color: colores[clase] || "#999999",
      weight: 1,
      fillOpacity: 0.6
    };
  }

  function cargarGeojson(nombre, url, estilo) {
    fetch(url)
      .then(response => response.json())
      .then(data => {
        const capa = L.geoJSON(data, {
          style: typeof estilo === 'function' ? estilo : () => estilo,
          pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
              radius: 6,
              fillColor: estilo.color || "blue",
              color: "#000",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            });
          },
          onEachFeature: function (feature, layer) {
            let popup = "<strong>" + nombre + "</strong><br>";
            for (const key in feature.properties) {
              popup += `<b>${key}:</b> ${feature.properties[key]}<br>`;
            }
            layer.bindPopup(popup);

            // Tabla de atributos al hacer clic (mostrar tabla en popup)
            layer.on('click', function () {
              let tabla = '<table border="1" style="border-collapse:collapse; width:100%;">';
              tabla += '<thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>';
              for (const key in feature.properties) {
                tabla += `<tr><td>${key}</td><td>${feature.properties[key]}</td></tr>`;
              }
              tabla += '</tbody></table>';
              layer.bindPopup(tabla).openPopup();
            });
          }
        }).addTo(map);

        overlayLayers[nombre] = capa;
        controlCapas.addOverlay(capa, nombre);

        if (nombre === "Sector") capaSector = capa;
        if (nombre === "NDVI 2020") capaNDVI2020 = capa;
        if (nombre === "NDVI 2024") capaNDVI2024 = capa;
      })
      .catch(error => console.error("Error al cargar " + nombre, error));
  }

  const controlCapas = L.control.layers(null, overlayLayers).addTo(map);

  // Cargar capas
  cargarGeojson("Sector", "https://veanbhxzftwbcbwmlzhq.supabase.co/storage/v1/object/public/samantha2017//Poblados.geojson", {
    color: "#ff7f00"
  });
  cargarGeojson("AOI", "https://veanbhxzftwbcbwmlzhq.supabase.co/storage/v1/object/public/samantha2017//AOI.geojson", {
    color: "#1f78b4"
  });
  cargarGeojson("NDVI 2020", "https://veanbhxzftwbcbwmlzhq.supabase.co/storage/v1/object/public/samantha2017//NDVI_2020_02.geojson", estiloNDVI);
  cargarGeojson("NDVI 2024", "https://veanbhxzftwbcbwmlzhq.supabase.co/storage/v1/object/public/samantha2017//NDVI_2024_08.geojson", estiloNDVI);

  // Esperar a que se carguen las capas para activar sideBySide
  function esperarComparacion() {
    if (capaNDVI2020 && capaNDVI2024) {
      // NO activamos automáticamente para que el usuario decida con botón
      // sideBySideControl = L.control.sideBySide(capaNDVI2020, capaNDVI2024).addTo(map);
    } else {
      setTimeout(esperarComparacion, 500);
    }
  }
  esperarComparacion();

  // Función para activar/desactivar comparación
  function toggleCompararNDVI() {
    if (sideBySideControl) {
      map.removeControl(sideBySideControl);
      sideBySideControl = null;
      this.textContent = "Activar comparación NDVI";
    } else if (capaNDVI2020 && capaNDVI2024) {
      sideBySideControl = L.control.sideBySide(capaNDVI2020, capaNDVI2024).addTo(map);
      document.querySelector("#compararNDVI button").textContent = "Desactivar comparación NDVI";
    } else {
      alert("Las capas NDVI aún no han cargado.");
    }
  }

  // Buscar sector
  function buscarSector() {
    const texto = document.getElementById("inputSector").value.trim().toLowerCase();
    if (!texto || !capaSector) {
      alert("Ingrese un nombre de sector válido.");
      return;
    }

    let encontrado = false;
    capaSector.eachLayer(function (layer) {
      const nombre = (layer.feature.properties.name || "").toLowerCase();
      if (nombre.includes(texto)) {
        map.fitBounds(layer.getBounds());
        layer.openPopup();
        encontrado = true;
      }
    });

    if (!encontrado) {
      alert("No se encontró ningún sector con ese nombre.");
    }
  }

  // Exportar mapa como PNG usando leaflet-image
  function exportarMapa() {
    leafletImage(map, function(err, canvas) {
      if (err) {
        alert("Error al generar la imagen.");
        return;
      }
      var img = canvas.toDataURL("image/png");
      var link = document.createElement('a');
      link.href = img;
      link.download = "mapa.png";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  }

  // Descargar atributos de capa Sector como CSV
  function descargarCSV() {
    if (!capaSector) {
      alert("La capa Sector aún no ha cargado.");
      return;
    }
    let csv = "Nombre,Atributos\n";
    capaSector.eachLayer(function(layer) {
      const props = layer.feature.properties;
      let row = (props.name || "") + ",";
      // Puedes agregar más propiedades si quieres en el CSV
      // Aquí simplemente concatena las propiedades separadas por ;
      let atributos = Object.entries(props).map(([k,v]) => `${k}:${v}`).join(";");
      row += `"${atributos}"\n`;
      csv += row;
    });

    var blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "atributos_sector.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>

</body>
</html>
